{% extends 'signals/base.html' %}

{% block title %}–¢–æ—Ä–≥–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã{% endblock %}

{% block content %}
<div class="page-header">
    <h1>–¢–æ—Ä–≥–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã</h1>
    <div class="header-buttons">
        <button class="btn btn-primary" id="addSignalBtn">
            <span class="btn-icon">+</span>
            –î–æ–±–∞–≤–∏—Ç—å —Å–∏–≥–Ω–∞–ª
        </button>
        <button class="btn" id="toggleBotBtn">
            <span class="btn-icon">ü§ñ</span>
            <span class="bot-status">–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞</span>
        </button>
    </div>
</div>

<div class="filters">
    <div class="search-box">
        <input type="text" class="form-control" placeholder="–ü–æ–∏—Å–∫ —Å–∏–≥–Ω–∞–ª–æ–≤...">
        <span class="search-icon">üîç</span>
    </div>
    <div class="filter-group">
        <select class="form-control">
            <option value="">–í—Å–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</option>
            <option value="long">Long</option>
            <option value="short">Short</option>
        </select>
    </div>
    <div class="filter-group">
        <select class="form-control">
            <option value="">–í—Å–µ —Å–∏–º–≤–æ–ª—ã</option>
            <option value="silver">Silver</option>
            <option value="gold">Gold</option>
        </select>
    </div>
</div>

{% if signals %}
<div class="signals-list">
    {% for signal in signals %}
    <a href="{% url 'signals:signal_detail' signal.id %}" class="signal-card">
        <div class="signal-header">
            <h2 class="signal-title">{{ signal.symbol }}</h2>
            <span class="signal-direction {{ signal.direction|lower }}">{{ signal.direction }}</span>
        </div>
        <div class="signal-details">
            <div class="signal-info">
                <span class="signal-label">Magic Number</span>
                <span class="signal-value">{{ signal.magic_number }}</span>
            </div>
            <div class="signal-info">
                <span class="signal-label">–í—Ö–æ–¥</span>
                <span class="signal-value">{{ signal.entry_month }}/{{ signal.entry_day }}</span>
            </div>
            <div class="signal-info">
                <span class="signal-label">–í—ã—Ö–æ–¥</span>
                <span class="signal-value">{{ signal.takeprofit_month }}/{{ signal.takeprofit_day }}</span>
            </div>
            <div class="signal-info">
                <span class="signal-label">–†–∏—Å–∫</span>
                <span class="signal-value">{{ signal.risk }}%</span>
            </div>
            <div class="signal-info">
                <span class="signal-label">–°—Ç–æ–ø-–ª–æ—Å—Å</span>
                <span class="signal-value">{{ signal.stoploss }} ({{ signal.stoploss_type }})</span>
            </div>
            <div class="signal-info">
                <span class="signal-label">–í—Ä–µ–º—è –æ—Ç–∫—Ä—ã—Ç–∏—è</span>
                <span class="signal-value">{{ signal.open_time|date:"H:i" }}</span>
            </div>
        </div>
    </a>
    {% endfor %}
</div>
{% else %}
<div class="empty-state">
    <div class="empty-state-icon">üìä</div>
    <div class="empty-state-text">–ü–æ–∫–∞ –Ω–µ—Ç —Å–∏–≥–Ω–∞–ª–æ–≤</div>
    <button class="btn btn-primary" id="addFirstSignalBtn">
        <span class="btn-icon">+</span>
        –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π —Å–∏–≥–Ω–∞–ª
    </button>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleBotBtn = document.getElementById('toggleBotBtn');
    const botStatus = toggleBotBtn.querySelector('.bot-status');
    
    // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—Ç–∞
    fetch('/trading_bot/api/bot/state/')
        .then(response => response.json())
        .then(data => {
            updateBotButton(data.is_running);
        });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ
    toggleBotBtn.addEventListener('click', function() {
        fetch('/trading_bot/api/bot/toggle/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            updateBotButton(data.is_running);
        });
    });
    
    function updateBotButton(isRunning) {
        toggleBotBtn.className = `btn ${isRunning ? 'btn-success' : 'btn-secondary'}`;
        botStatus.textContent = isRunning ? '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞' : '–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %} 